/*******************************************************************
** s o f t c o r e . c
** Forth Inspired Command Language -
** Words from CORE set written in FICL
** Author: John Sadler (john_sadler@alum.mit.edu)
** Created: 27 December 1997
** Last update: Tue Dec 15 18:29:46 UTC 2015
*******************************************************************/
/*
** DO NOT EDIT THIS FILE -- it is generated by softwords/softcore.awk
** Make changes to the .fr files in ficl/softwords instead.
** This file contains definitions that are compiled into the
** system dictionary by the first virtual machine to be created.
** Created automagically by ficl/softwords/softcore.awk
*/
/*
** Copyright (c) 1997-2001 John Sadler (john_sadler@alum.mit.edu)
** All rights reserved.
**
** Get the latest Ficl release at http://ficl.sourceforge.net
**
** I am interested in hearing from anyone who uses ficl. If you have
** a problem, a success story, a defect, an enhancement request, or
** if you would like to contribute to the ficl release, please send
** contact me by email at the address above.
**
** L I C E N S E  and  D I S C L A I M E R
** 
** Redistribution and use in source and binary forms, with or without
** modification, are permitted provided that the following conditions
** are met:
** 1. Redistributions of source code must retain the above copyright
**    notice, this list of conditions and the following disclaimer.
** 2. Redistributions in binary form must reproduce the above copyright
**    notice, this list of conditions and the following disclaimer in the
**    documentation and/or other materials provided with the distribution.
**
** THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
** ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
** IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
** ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
** FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
** DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
** OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
** HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
** LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
** OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
** SUCH DAMAGE.
*/


#include "ficl.h"

static char softWords[] =
#if FICL_WANT_SOFTWORDS
/*
** ficl/softwords/softcore.fr
** FICL soft extensions
** John Sadler (john_sadler@alum.mit.edu)
** September, 1998
*/
/*
** Ficl USER variables
** See words.c for primitive def'n of USER
*/
#if FICL_WANT_USER
    "variable nUser  0 nUser ! "
    ": user "
    "nUser dup @ user 1 swap +! ; "
#endif
/*
** ficl extras
*/
    ": empty depth 0 ?do drop loop ; "
    ": cell-  [ 1 cells ] literal -  ; "
    ": -rot  2 -roll ; "
/*
** CORE 
*/
    ": abs "
    "dup 0< if negate endif ; "
    "decimal 32 constant bl "
    ": space     bl emit ; "
    ": spaces   0 ?do space loop ; "
    ": abort\" "
    "state @ if "
    "postpone if "
    "postpone .\" "
    "postpone cr "
    "-2 "
    "postpone literal "
    "postpone throw "
    "postpone endif "
    "else "
    "[char] \" parse "
    "rot if "
    "type "
    "cr "
    "-2 throw "
    "else "
    "2drop "
    "endif "
    "endif "
    "; immediate "
/*
** CORE EXT
*/
    "0  constant false "
    "false invert constant true "
    ": <>   = 0= ; "
    ": 0<>  0= 0= ; "
    ": compile,  , ; "
    ": convert   char+ 65535 >number drop ; "
    ": erase    0 fill ; "
    "variable span "
    ": expect accept span ! ; "
    ": nip     swap drop ; "
    ": tuck  swap over ; "
    ": within   over - >r - r>  u<  ; "
/*
** LOCAL EXT word set
*/
#if FICL_WANT_LOCALS
    ": locals| "
    "begin "
    "bl word   count "
    "dup 0= abort\" where's the delimiter??\" "
    "over c@ "
    "[char] | - over 1- or "
    "while "
    "(local) "
    "repeat 2drop   0 0 (local) "
    "; immediate "
    ": local  bl word count (local) ;  immediate "
    ": 2local bl word count (2local) ; immediate "
    ": end-locals  0 0 (local) ;  immediate "
#endif
/*
** TOOLS word set...
*/
    ": ?  @ . ; "
    ": dump "
    "0 ?do "
    "dup c@ . 1+ "
    "i 7 and 7 = if cr endif "
    "loop drop "
    "; "
/*
** SEARCH+EXT words and ficl helpers
*/
    ": brand-wordlist   last-word >name drop wid-set-name ; "
    ": ficl-named-wordlist "
    "ficl-wordlist dup create , brand-wordlist does> @ ; "
    ": wordlist "
    "1 ficl-wordlist ; "
    ": ficl-set-current "
    "get-current swap set-current ; "
    ": do-vocabulary "
    "does>  @ search> drop >search ; "
    ": ficl-vocabulary "
    "ficl-named-wordlist do-vocabulary ; "
    ": vocabulary "
    "1 ficl-vocabulary ; "
    ": previous  search> drop ; "
    "1 ficl-named-wordlist hidden "
    ": hide     hidden dup >search ficl-set-current ; "
    ": also "
    "search> dup >search >search ; "
    ": forth "
    "search> drop "
    "forth-wordlist >search ; "
    ": only "
    "-1 set-order ; "
    "hide "
    ": list-wid "
    "dup wid-get-name "
    "?dup if "
    "type drop "
    "else "
    "drop .\" (unnamed wid) \" x. "
    "endif cr "
    "; "
    "set-current "
    ": order "
    ".\" Search:\" cr "
    "get-order  0 ?do 3 spaces list-wid loop cr "
    ".\" Compile: \" get-current list-wid cr "
    "; "
    ": debug  ' debug-xt ; immediate "
    ": on-step   .\" S: \" .s cr ; "
    ": strdup "
    "0 locals| addr2 length c-addr | end-locals "
    "length 1 + allocate "
    "0= if "
    "to addr2 "
    "c-addr addr2 length move "
    "addr2 length 0 "
    "else "
    "0  -1 "
    "endif "
    "; "
    ": strcat "
    "0 locals|  b-length b-u b-addr a-u a-addr | end-locals "
    "b-u  to b-length "
    "b-addr a-addr a-u + b-length  move "
    "a-addr a-u b-length + "
    "; "
    ": strcpy "
    "locals| b-u b-addr a-u a-addr | end-locals "
    "a-addr 0  b-addr b-u  strcat "
    "; "
    "previous "
/*
** E N D   S O F T C O R E . F R
*/
#if FICL_WANT_LOCALS
/*
** ficl/softwords/jhlocal.fr
** stack comment style local syntax...
*/
    "hide "
    "0 constant zero "
    ": ?-- "
    "2dup s\" --\" compare 0= ; "
    ": ?} "
    "2dup s\" }\"  compare 0= ; "
    ": ?| "
    "2dup s\" |\"  compare 0= ; "
    ": ?2loc "
    "over dup c@ [char] 2 = "
    "swap 1+  c@ [char] : = and "
    "if "
    "2 - swap char+ char+ swap "
    "true "
    "else "
    "false "
    "endif "
    "; "
    ": ?delim "
    "?|  if  2drop 1 exit endif "
    "?-- if  2drop 2 exit endif "
    "?}  if  2drop 3 exit endif "
    "dup 0= "
    "if  2drop 4 exit endif "
    "0 "
    "; "
    "set-current "
    ": { "
    "0 dup locals| locstate | "
    "begin "
    "parse-word "
    "?delim dup to locstate "
    "0= while "
    "rot 1+ "
    "repeat "
    "0 ?do "
    "?2loc if (2local) else (local) endif "
    "loop "
    "locstate 1 = if "
    "begin "
    "parse-word "
    "?delim dup to locstate "
    "0= while "
    "?2loc if "
    "postpone zero postpone zero (2local) "
    "else "
    "postpone zero (local) "
    "endif "
    "repeat "
    "endif "
    "0 0 (local) "
    "locstate 2 = if "
    "begin "
    "parse-word "
    "?delim dup  to locstate "
    "3 < while "
    "locstate 0=  if 2drop endif "
    "repeat "
    "endif "
    "locstate 3 <> abort\" syntax error in { } local line\" "
    "; immediate compile-only "
    "previous "
#endif
/*
** ficl/softwords/marker.fr
** Ficl implementation of CORE EXT MARKER
*/
    ": marker "
    "create "
    "get-current , "
    "get-order dup , "
    "0 ?do , loop "
    "does> "
    "0 set-order "
    "dup body> >name drop "
    "here - allot "
    "dup @ "
    "dup set-current forget-wid "
    "cell+ dup @ swap "
    "over cells + swap "
    "0 ?do "
    "dup @ dup "
    ">search forget-wid "
    "cell- "
    "loop "
    "drop "
    "; "
/*
** Copyright (c) 1998 Daniel C. Sobral <dcs@freebsd.org>
** All rights reserved.
**
** Redistribution and use in source and binary forms, with or without
** modification, are permitted provided that the following conditions
** are met:
** 1. Redistributions of source code must retain the above copyright
**    notice, this list of conditions and the following disclaimer.
** 2. Redistributions in binary form must reproduce the above copyright
**    notice, this list of conditions and the following disclaimer in the
**    documentation and/or other materials provided with the distribution.
**
** THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
** ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
** IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
** ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
** FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
** DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
** OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
** HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
** LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
** OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
** SUCH DAMAGE.
**
** $FreeBSD$
*/
    ": tib> source >in @ tuck over >in ! - >r + r> ; "
    ": % tib> ['] evaluate catch drop ; "
    ": $ tib> 2dup type cr evaluate ; "
/*
** E N D   F R E E B S D . F R
** ficl/softwords/ficllocal.fr
** stack comment style local syntax...
*/
    "hide "
    "0 constant zero "
    ": ?--   s\" --\" compare 0= ; "
    ": ?}}   s\" }}\" compare 0= ; "
    "set-current "
    ": {{ "
    "0 dup  locals| nLocs locstate | "
    "begin "
    "parse-word "
    "?dup 0= abort\" Error: out of text without seeing }}\" "
    "2dup 2dup  ?-- -rot ?}} or 0= "
    "while "
    "nLocs 1+ to nLocs "
    "repeat "
    "?-- if 1 to locstate endif "
    "nLocs 0 do "
    "(local) "
    "loop "
    "locstate 1 = if "
    "begin "
    "parse-word "
    "2dup ?}} 0= "
    "while "
    "postpone zero  (local) "
    "repeat "
    "2drop "
    "endif "
    "0 0 (local) "
    "; immediate compile-only "
    "previous "
/*
** ficl/softwords/ifbrack.fr
** ANS conditional compile directives [if] [else] [then]
** Requires ficl 2.0 or greater...
*/
    "hide "
    ": ?[if] "
    "2dup s\" [if]\" compare-insensitive 0= "
    "; "
    ": ?[else] "
    "2dup s\" [else]\" compare-insensitive 0= "
    "; "
    ": ?[then] "
    "2dup s\" [then]\" compare-insensitive 0= >r "
    "2dup s\" [endif]\" compare-insensitive 0= r> "
    "or "
    "; "
    "set-current "
    ": [else] "
    "1 "
    "begin "
    "begin "
    "parse-word dup  while "
    "?[if] if "
    "2drop 1+ "
    "else "
    "?[else] if "
    "2drop 1- dup if 1+ endif "
    "else "
    "?[then] if 2drop 1- else 2drop endif "
    "endif "
    "endif ?dup 0=  if exit endif "
    "repeat  2drop "
    "refill 0= until "
    "drop "
    ";  immediate "
    ": [if] "
    "0= if postpone [else] then ;  immediate "
    ": [then]  ;  immediate "
    ": [endif]  ;  immediate "
    "previous "
#endif /* WANT_SOFTWORDS */
    "quit ";


void ficlCompileSoftCore(FICL_SYSTEM *pSys)
{
    FICL_VM *pVM = pSys->vmList;
    CELL id = pVM->sourceID;
    int ret = sizeof (softWords);
	  assert(pVM);
    pVM->sourceID.i = -1;
    ret = ficlExec(pVM, softWords);
    pVM->sourceID = id;
    if (ret == VM_ERREXIT)
        assert(FALSE);
    return;
}
